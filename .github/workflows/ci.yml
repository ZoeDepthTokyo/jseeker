name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint (ruff + black)
    # jSeeker pre-commit uses both ruff and black; both are checked here.
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install linters
        run: pip install "ruff>=0.1.0" "black>=23.0.0"

      - name: ruff lint
        run: ruff check .

      - name: black format check
        run: black --check --line-length=100 .

  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        # pyproject.toml requires-python = ">=3.11"; 3.10 is not supported.
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install package and dev dependencies
        # requirements.txt is for GAIA local-install notes only; the actual
        # package dependencies are declared in pyproject.toml.
        # pip install -e ".[dev]" installs jseeker editable plus
        # pytest, pytest-cov, ruff, and black from [dev] extras.
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        # PDF and e2e tests are excluded: test_pdf_formatting.py requires
        # a live WeasyPrint/Playwright environment; test_e2e_scenarios.py
        # requires a running browser session.
        # Tests that call the Anthropic API will be skipped automatically
        # when ANTHROPIC_API_KEY is absent (tests use pytest.mark.skipif or
        # catch the missing-key AuthenticationError).
        run: |
          python -m pytest tests/ \
            --cov=jseeker \
            --cov-report=term-missing \
            --cov-report=xml \
            --ignore=tests/test_pdf_formatting.py \
            --ignore=tests/test_e2e_scenarios.py \
            -v
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload coverage XML (3.12 only)
        if: matrix.python-version == '3.12'
        uses: actions/upload-artifact@v4
        with:
          name: jseeker-coverage-xml
          path: coverage.xml

  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for hardcoded API keys
        # Fails the job if any OpenAI or Anthropic key patterns are found in
        # Python source files. This is a fast grep-based gate before any
        # install happens, so it costs ~1s regardless of dependency weight.
        run: |
          echo "Scanning for hardcoded API keys..."
          if grep -rn --include="*.py" "sk-[a-zA-Z0-9]\{20,\}" .; then
            echo "FAIL: Potential OpenAI key found in source"
            exit 1
          fi
          if grep -rn --include="*.py" "sk-ant-[a-zA-Z0-9]\{20,\}" .; then
            echo "FAIL: Potential Anthropic key found in source"
            exit 1
          fi
          echo "PASS: No hardcoded API keys detected"
